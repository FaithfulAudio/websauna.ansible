# Playbook which ramps up myapp tutorial site inside a Vagrant virtual machine

- hosts: all
  become: yes
  become_user: root
  gather_facts: true

  # These need to be set up before reading default.yml - more variables are generated based on these
  vars:
    - package_name: myapp
    - site_id: myapp_production
    - site_mode: production
    - mandrill: on
    - ssl: off
    - cloudflare: off
    - new_relic: off
    - notify_email: mikko@example.com
    - git_repository: git@github.com:websauna/myapp.git
    - certificate_file: tests/snakeoil.pem
    - key_file: tests/snakeoil.pem

  pre_tasks:

    # Load default vars based on playbook.yml input
    - include_vars: default.yml

    # Load variables from the vault
    - include_vars: secrets.yml

    # local-configure.yml is generated by a test runner
    - name: Include vars from local-configure.yml if found
      include_vars: "{{ item }}"
      with_first_found:
       - local-configure.yml
       - null.yml

  roles:
  - websauna.preflight
  - websauna.users
  - websauna.ssh
  - websauna.harden
  - websauna.postfix
  - websauna.mandrill
  - ANXS.postgresql
  - Stouts.nginx
  - Stouts.redis
  - Stouts.python
  - { role: websauna.site, tags: [ 'site-update'] }
  - websauna.postflight


